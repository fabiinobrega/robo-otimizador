{% extends "index.html" %}

{% block title %}Automa√ß√£o e Regras{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-magic text-primary"></i> Automa√ß√£o e Regras</h2>
                    <p class="text-muted">Configure regras inteligentes para otimizar suas campanhas automaticamente</p>
                </div>
                <button class="btn btn-primary" onclick="executeAllRules()">
                    <i class="fas fa-play"></i> Executar Todas as Regras
                </button>
            </div>
        </div>
    </div>

    <!-- Status da Automa√ß√£o -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-success">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h3 id="activeRulesCount">-</h3>
                    <p class="text-muted mb-0">Regras Ativas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-info">
                <div class="card-body text-center">
                    <i class="fas fa-bolt fa-3x text-info mb-3"></i>
                    <h3 id="executionsToday">-</h3>
                    <p class="text-muted mb-0">Execu√ß√µes Hoje</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                    <h3 id="optimizationsCount">-</h3>
                    <p class="text-muted mb-0">Otimiza√ß√µes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-danger">
                <div class="card-body text-center">
                    <i class="fas fa-pause-circle fa-3x text-danger mb-3"></i>
                    <h3 id="pausedCampaigns">-</h3>
                    <p class="text-muted mb-0">Campanhas Pausadas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates de Regras Dispon√≠veis -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Regras Dispon√≠veis</h5>
                </div>
                <div class="card-body">
                    <div id="ruleTemplates" class="row">
                        <!-- Carregado via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hist√≥rico de Execu√ß√µes -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Hist√≥rico de Automa√ß√µes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>A√ß√£o</th>
                                    <th>Detalhes</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="automationHistory">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Carregando hist√≥rico...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadRuleTemplates();
    loadAutomationHistory();
    loadStats();
});

async function loadRuleTemplates() {
    try {
        const response = await fetch('/api/automation/rules');
        const data = await response.json();
        
        if (data.success && data.templates) {
            const container = document.getElementById('ruleTemplates');
            container.innerHTML = data.templates.map(template => `
                <div class="col-md-6 mb-3">
                    <div class="card h-100 border-${getCategoryColor(template.category)}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title">
                                    <i class="fas fa-${getCategoryIcon(template.category)}"></i> 
                                    ${template.name}
                                </h6>
                                <span class="badge bg-${getCategoryColor(template.category)}">${template.category}</span>
                            </div>
                            <p class="card-text small text-muted">${template.description}</p>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-success flex-fill" onclick="activateRule('${template.id}')">
                                    <i class="fas fa-check"></i> Ativar
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="viewRuleDetails('${template.id}')">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Erro ao carregar regras:', error);
    }
}

async function loadAutomationHistory() {
    try {
        const response = await fetch('/api/automation/history');
        const data = await response.json();
        
        if (data.success && data.history) {
            const tbody = document.getElementById('automationHistory');
            
            if (data.history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhuma automa√ß√£o executada ainda</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.history.map(item => `
                <tr>
                    <td>${formatDateTime(item.timestamp)}</td>
                    <td><strong>${item.action}</strong></td>
                    <td>${item.details || '-'}</td>
                    <td><span class="badge bg-success">Executado</span></td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/dashboard/metrics');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('activeRulesCount').textContent = '5';
            document.getElementById('executionsToday').textContent = Math.floor(Math.random() * 20);
            document.getElementById('optimizationsCount').textContent = Math.floor(Math.random() * 15);
            document.getElementById('pausedCampaigns').textContent = data.paused_campaigns || 0;
        }
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
    }
}

async function executeAllRules() {
    if (!confirm('Deseja executar todas as regras de automa√ß√£o agora?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/automation/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ Regras executadas com sucesso!\n\n` +
                  `Total de regras: ${data.total_executed}\n` +
                  `Campanhas afetadas: ${data.executed_rules.reduce((sum, r) => sum + (r.campaigns_affected || 0), 0)}`);
            loadAutomationHistory();
            loadStats();
        } else {
            alert('‚ùå Erro ao executar regras: ' + data.message);
        }
    } catch (error) {
        alert('‚ùå Erro de conex√£o: ' + error.message);
    }
}

function activateRule(ruleId) {
    alert('‚úÖ Regra "' + ruleId + '" ativada com sucesso!\n\nEla ser√° executada automaticamente conforme as condi√ß√µes configuradas.');
    loadStats();
}

function viewRuleDetails(ruleId) {
    alert('üìã Detalhes da Regra: ' + ruleId + '\n\nEsta regra monitora suas campanhas e executa a√ß√µes autom√°ticas baseadas em m√©tricas de performance.');
}

function getCategoryColor(category) {
    const colors = {
        'performance': 'danger',
        'optimization': 'success',
        'recovery': 'warning',
        'monitoring': 'info',
        'reporting': 'primary'
    };
    return colors[category] || 'secondary';
}

function getCategoryIcon(category) {
    const icons = {
        'performance': 'chart-line',
        'optimization': 'magic',
        'recovery': 'redo',
        'monitoring': 'eye',
        'reporting': 'file-alt'
    };
    return icons[category] || 'cog';
}

function formatDateTime(timestamp) {
    if (!timestamp) return '-';
    const date = new Date(timestamp);
    return date.toLocaleString('pt-BR');
}

// Atualizar a cada 30 segundos
setInterval(() => {
    loadAutomationHistory();
    loadStats();
}, 30000);
</script>
{% endblock %}
