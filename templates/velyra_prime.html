{% extends "base_nexora.html" %}

{% block title %}Velyra Prime - NEXORA{% endblock %}

{% block content %}
<div class="nexora-page">
    <!-- Header -->
    <div class="nexora-page-header">
        <div>
            <h1 class="nexora-page-title">Velyra Prime</h1>
            <p class="nexora-page-subtitle">Assistente IA para automa√ß√£o e otimiza√ß√£o de campanhas</p>
        </div>
        <div class="nexora-page-actions">
            <button class="nexora-btn nexora-btn-secondary" id="clearChatBtn">
                <i class="fas fa-trash"></i>
                Limpar Chat
            </button>
        </div>
    </div>

    <!-- Status Card -->
    <div class="nexora-card" style="margin-bottom: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-robot" style="font-size: 24px; color: white;"></i>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Status da Velyra Prime</h3>
                    <p id="velyraStatus" style="margin: 4px 0 0 0; font-size: 14px; color: var(--text-secondary);">
                        <i class="fas fa-circle" style="color: var(--success-color); font-size: 8px;"></i>
                        Ativa e monitorando
                    </p>
                </div>
            </div>
            <div style="display: flex; gap: 16px;">
                <div style="text-align: center;">
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">√öltima Otimiza√ß√£o</p>
                    <p id="lastOptimization" style="margin: 4px 0 0 0; font-size: 14px; font-weight: 600;">H√° 12 minutos</p>
                </div>
                <div style="text-align: center;">
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">A√ß√µes Executadas</p>
                    <p id="actionsCount" style="margin: 4px 0 0 0; font-size: 14px; font-weight: 600;">47</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Training Card -->
    <div class="nexora-card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,212,255,0.1)); border: 1px solid rgba(0,255,136,0.3);">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #00ff88, #00d4ff); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-graduation-cap" style="font-size: 24px; color: #000;"></i>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">üéì Treinamento Estrat√©gico</h3>
                    <p style="margin: 4px 0 0 0; font-size: 14px; color: var(--text-secondary);">
                        Capacita√ß√£o completa em Marketing Digital para a Velyra Prime
                    </p>
                </div>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <div id="trainingProgress" style="text-align: center; padding: 8px 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">M√≥dulos</p>
                    <p style="margin: 0; font-size: 18px; font-weight: 700; color: #00ff88;">0/11</p>
                </div>
                <a href="/velyra-training" class="nexora-btn nexora-btn-primary" style="text-decoration: none;">
                    <i class="fas fa-play"></i>
                    Iniciar Treinamento
                </a>
            </div>
        </div>
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                <i class="fas fa-info-circle" style="color: #00ff88;"></i>
                <strong>Importante:</strong> A Velyra s√≥ pode criar campanhas reais ap√≥s completar o treinamento obrigat√≥rio de 11 m√≥dulos.
            </p>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="nexora-card" style="height: calc(100vh - 400px); display: flex; flex-direction: column;">
        <!-- Chat Messages -->
        <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px;">
            <!-- Welcome Message -->
            <div class="chat-message chat-message-assistant">
                <div class="chat-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chat-message-content">
                    <p><strong>Velyra Prime</strong></p>
                    <p>Ol√°! Sou a Velyra Prime, sua assistente de automa√ß√£o de marketing. Como posso ajudar voc√™ hoje?</p>
                    <p style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">
                        Voc√™ pode me perguntar sobre:
                    </p>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: var(--text-secondary);">
                        <li>Status das campanhas</li>
                        <li>Recomenda√ß√µes de otimiza√ß√£o</li>
                        <li>An√°lise de performance</li>
                        <li>Cria√ß√£o de novas campanhas</li>
                        <li>üìé Envie m√≠dias para criar an√∫ncios personalizados</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Media Preview Area -->
        <div id="mediaPreviewArea" style="display: none; border-top: 1px solid var(--border-color); padding: 12px 20px; background: var(--surface-color);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 13px; color: var(--text-secondary);">
                    <i class="fas fa-paperclip"></i>
                    M√≠dias anexadas
                </span>
                <button id="clearMediaBtn" class="nexora-btn nexora-btn-secondary" style="padding: 4px 8px; font-size: 12px;">
                    <i class="fas fa-times"></i>
                    Limpar
                </button>
            </div>
            <div id="mediaPreviewContainer" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
        </div>

        <!-- Chat Input -->
        <div style="border-top: 1px solid var(--border-color); padding: 20px;">
            <div style="display: flex; gap: 12px; align-items: flex-end;">
                <!-- Upload Button -->
                <div class="upload-btn-wrapper">
                    <button id="uploadMediaBtn" class="nexora-btn nexora-btn-secondary" title="Anexar m√≠dia (imagem ou v√≠deo)">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="mediaInput" accept="image/*,video/*" multiple style="display: none;" />
                </div>
                
                <!-- Text Input -->
                <input 
                    type="text" 
                    id="chatInput" 
                    class="nexora-input" 
                    placeholder="Digite sua mensagem ou anexe m√≠dias para criar an√∫ncios..."
                    style="flex: 1;"
                />
                
                <!-- Send Button -->
                <button id="sendMessageBtn" class="nexora-btn nexora-btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Enviar
                </button>
            </div>
            <p style="margin: 12px 0 0 0; font-size: 12px; color: var(--text-secondary);">
                <i class="fas fa-info-circle"></i>
                Dica: Anexe imagens ou v√≠deos e pe√ßa "Crie um an√∫ncio com esta m√≠dia para [produto]"
            </p>
        </div>
    </div>
</div>

<style>
.chat-message {
    display: flex;
    gap: 12px;
    animation: slideIn 0.3s ease-out;
}

.chat-message-assistant {
    align-self: flex-start;
}

.chat-message-user {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.chat-message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    flex-shrink: 0;
}

.chat-message-user .chat-message-avatar {
    background: var(--surface-color);
    color: var(--text-primary);
}

.chat-message-content {
    background: var(--surface-color);
    padding: 16px;
    border-radius: 12px;
    max-width: 70%;
}

.chat-message-user .chat-message-content {
    background: var(--primary-color);
    color: white;
}

.chat-message-content p {
    margin: 0;
    line-height: 1.6;
}

.chat-message-content p + p {
    margin-top: 12px;
}

/* Media in messages */
.chat-message-media {
    margin-top: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.chat-message-media img,
.chat-message-media video {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    object-fit: cover;
}

/* Media preview */
.media-preview-item {
    position: relative;
    display: inline-block;
}

.media-preview-item img,
.media-preview-item video {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid var(--border-color);
}

.media-preview-item .remove-media {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--danger-color);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
}

.media-preview-item .media-type-badge {
    position: absolute;
    bottom: 4px;
    left: 4px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(0,0,0,0.7);
    color: white;
    font-size: 10px;
}

/* Upload button */
.upload-btn-wrapper {
    position: relative;
}

.upload-btn-wrapper:hover button {
    background: var(--primary-color);
    color: white;
}

/* Drag and drop */
.drag-over {
    border: 2px dashed var(--primary-color) !important;
    background: rgba(0, 212, 255, 0.1) !important;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Loading indicator */
.chat-loading {
    display: flex;
    gap: 6px;
    padding: 12px 0;
}

.chat-loading span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-secondary);
    animation: bounce 1.4s infinite ease-in-out both;
}

.chat-loading span:nth-child(1) {
    animation-delay: -0.32s;
}

.chat-loading span:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes bounce {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}

/* Markdown rendering in chat */
.chat-message-content h1, 
.chat-message-content h2, 
.chat-message-content h3 {
    margin: 16px 0 8px 0;
    font-weight: 600;
}

.chat-message-content ul, 
.chat-message-content ol {
    margin: 8px 0;
    padding-left: 20px;
}

.chat-message-content li {
    margin: 4px 0;
}

.chat-message-content code {
    background: rgba(0,0,0,0.2);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
}

.chat-message-content pre {
    background: rgba(0,0,0,0.3);
    padding: 12px;
    border-radius: 8px;
    overflow-x: auto;
}

.chat-message-content blockquote {
    border-left: 3px solid var(--primary-color);
    padding-left: 12px;
    margin: 12px 0;
    color: var(--text-secondary);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const uploadMediaBtn = document.getElementById('uploadMediaBtn');
    const mediaInput = document.getElementById('mediaInput');
    const mediaPreviewArea = document.getElementById('mediaPreviewArea');
    const mediaPreviewContainer = document.getElementById('mediaPreviewContainer');
    const clearMediaBtn = document.getElementById('clearMediaBtn');

    // Store uploaded files
    let uploadedFiles = [];

    // Load Velyra Prime status
    loadVelyraStatus();

    // Send message
    sendMessageBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Clear chat
    clearChatBtn.addEventListener('click', function() {
        if (confirm('Deseja limpar todo o hist√≥rico de chat?')) {
            const welcomeMessage = chatMessages.querySelector('.chat-message-assistant');
            chatMessages.innerHTML = '';
            chatMessages.appendChild(welcomeMessage);
        }
    });

    // Upload media button
    uploadMediaBtn.addEventListener('click', function() {
        mediaInput.click();
    });

    // Handle file selection
    mediaInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    // Clear media
    clearMediaBtn.addEventListener('click', function() {
        uploadedFiles = [];
        mediaPreviewContainer.innerHTML = '';
        mediaPreviewArea.style.display = 'none';
    });

    // Drag and drop support
    const chatCard = document.querySelector('.nexora-card:last-child');
    
    chatCard.addEventListener('dragover', function(e) {
        e.preventDefault();
        chatCard.classList.add('drag-over');
    });

    chatCard.addEventListener('dragleave', function(e) {
        e.preventDefault();
        chatCard.classList.remove('drag-over');
    });

    chatCard.addEventListener('drop', function(e) {
        e.preventDefault();
        chatCard.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        for (let file of files) {
            if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                uploadedFiles.push(file);
                addMediaPreview(file);
            } else {
                alert('Apenas imagens e v√≠deos s√£o aceitos.');
            }
        }
        
        if (uploadedFiles.length > 0) {
            mediaPreviewArea.style.display = 'block';
        }
    }

    function addMediaPreview(file) {
        const previewItem = document.createElement('div');
        previewItem.className = 'media-preview-item';
        
        const isVideo = file.type.startsWith('video/');
        const fileIndex = uploadedFiles.length - 1;
        
        if (isVideo) {
            const video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.muted = true;
            previewItem.appendChild(video);
        } else {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            previewItem.appendChild(img);
        }
        
        // Type badge
        const badge = document.createElement('span');
        badge.className = 'media-type-badge';
        badge.innerHTML = isVideo ? '<i class="fas fa-video"></i>' : '<i class="fas fa-image"></i>';
        previewItem.appendChild(badge);
        
        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-media';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = function() {
            uploadedFiles.splice(fileIndex, 1);
            previewItem.remove();
            if (uploadedFiles.length === 0) {
                mediaPreviewArea.style.display = 'none';
            }
        };
        previewItem.appendChild(removeBtn);
        
        mediaPreviewContainer.appendChild(previewItem);
    }

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message && uploadedFiles.length === 0) return;

        // Add user message with media preview
        addMessage(message, 'user', uploadedFiles);
        chatInput.value = '';

        // Show loading
        const loadingId = showLoading();

        // Prepare form data
        const formData = new FormData();
        formData.append('message', message);
        
        // Add files
        for (let i = 0; i < uploadedFiles.length; i++) {
            formData.append('media', uploadedFiles[i]);
        }

        // Clear uploaded files
        const hadMedia = uploadedFiles.length > 0;
        uploadedFiles = [];
        mediaPreviewContainer.innerHTML = '';
        mediaPreviewArea.style.display = 'none';

        try {
            let response;
            
            if (hadMedia) {
                // Use multipart endpoint for media
                response = await fetch('/api/velyra/chat-with-media', {
                    method: 'POST',
                    body: formData
                });
            } else {
                // Use regular JSON endpoint
                response = await fetch('/api/velyra/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });
            }
            
            const data = await response.json();
            removeLoading(loadingId);
            
            if (data.success) {
                addMessage(data.response, 'assistant');
            } else {
                addMessage('Desculpe, ocorreu um erro ao processar sua mensagem.', 'assistant');
            }
        } catch (error) {
            removeLoading(loadingId);
            addMessage('Erro ao conectar com a Velyra Prime. Tente novamente.', 'assistant');
        }
    }

    function addMessage(text, sender, files = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message chat-message-${sender}`;
        
        // Format text with markdown-like rendering
        let formattedText = formatMessage(text);
        
        // Build media HTML
        let mediaHtml = '';
        if (files && files.length > 0) {
            mediaHtml = '<div class="chat-message-media">';
            for (let file of files) {
                if (file.type.startsWith('video/')) {
                    mediaHtml += `<video src="${URL.createObjectURL(file)}" controls style="max-width: 200px; border-radius: 8px;"></video>`;
                } else {
                    mediaHtml += `<img src="${URL.createObjectURL(file)}" alt="M√≠dia anexada">`;
                }
            }
            mediaHtml += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="chat-message-avatar">
                <i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i>
            </div>
            <div class="chat-message-content">
                <p><strong>${sender === 'user' ? 'Voc√™' : 'Velyra Prime'}</strong></p>
                ${formattedText}
                ${mediaHtml}
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatMessage(text) {
        if (!text) return '';
        
        // Convert markdown-like syntax to HTML
        let formatted = text
            // Bold
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            // Headers
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            // Lists
            .replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/^\* (.+)$/gm, '<li>$1</li>')
            // Numbered lists
            .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
            // Code blocks
            .replace(/```(.+?)```/gs, '<pre><code>$1</code></pre>')
            // Inline code
            .replace(/`(.+?)`/g, '<code>$1</code>')
            // Blockquotes
            .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
            // Line breaks
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');
        
        // Wrap in paragraph if not already
        if (!formatted.startsWith('<')) {
            formatted = '<p>' + formatted + '</p>';
        }
        
        return formatted;
    }

    function showLoading() {
        const loadingId = 'loading-' + Date.now();
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = 'chat-message chat-message-assistant';
        loadingDiv.innerHTML = `
            <div class="chat-message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="chat-message-content">
                <div class="chat-loading">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return loadingId;
    }

    function removeLoading(loadingId) {
        const loadingDiv = document.getElementById(loadingId);
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }

    function loadVelyraStatus() {
        fetch('/api/velyra/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('velyraStatus').innerHTML = `
                        <i class="fas fa-circle" style="color: var(--success-color); font-size: 8px;"></i>
                        ${data.status || 'Ativa e monitorando'}
                    `;
                    if (data.last_optimization) {
                        document.getElementById('lastOptimization').textContent = data.last_optimization;
                    }
                    if (data.actions_count) {
                        document.getElementById('actionsCount').textContent = data.actions_count;
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao carregar status:', error);
            });
    }

    // Refresh status every 30 seconds
    setInterval(loadVelyraStatus, 30000);
});
</script>
{% endblock %}
