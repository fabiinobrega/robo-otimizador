{% extends "base_nexora.html" %}

{% block title %}Gerar Anúncio Perfeito (1-Click) - NEXORA{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="fas fa-magic"></i> Gerar Anúncio Perfeito (1-Click)</h1>
        <span class="badge bg-success">Powered by Velyra Prime AI</span>
    </div>
    
    <div class="alert alert-info">
        <h5><i class="fas fa-robot"></i> Como funciona?</h5>
        <p>Cole o link do seu produto e deixe a IA criar anúncios otimizados automaticamente: copy, criativos, segmentação e publicação!</p>
    </div>

    <!-- Formulário Principal -->
    <div class="card mb-4" id="inputForm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">1. Informações do Produto</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">URL do Produto *</label>
                <input type="url" class="form-control form-control-lg" id="productUrl" 
                       placeholder="https://seusite.com/produto" required>
                <small class="text-muted">Cole o link da página de vendas do seu produto</small>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Plataforma *</label>
                    <select class="form-select" id="platform" required>
                        <option value="">Selecione...</option>
                        <option value="facebook">Facebook Ads</option>
                        <option value="google">Google Ads</option>
                        <option value="both">Ambas (Facebook + Google)</option>
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">Localização *</label>
                    <input type="text" class="form-control" id="location" 
                           placeholder="Brasil, São Paulo, etc." value="Brasil">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Meta de Vendas</label>
                    <input type="number" class="form-control" id="salesGoal" 
                           placeholder="100" value="100" min="1">
                    <small class="text-muted">Quantas vendas você quer alcançar?</small>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label class="form-label">Orçamento Total (R$) *</label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="number" class="form-control" id="budget" 
                               placeholder="1000" step="0.01" min="50" required>
                        <button class="btn btn-outline-secondary" type="button" onclick="suggestBudget()">
                            <i class="fas fa-magic"></i> Sugerir
                        </button>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label class="form-label">Duração da Campanha (dias) *</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="campaignDuration" 
                               placeholder="30" value="30" min="1" max="365" required>
                        <span class="input-group-text">dias</span>
                    </div>
                    <small class="text-muted">Por quantos dias a campanha vai rodar?</small>
                </div>
            </div>
            
            <!-- Orçamento Diário Calculado -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-secondary" id="dailyBudgetAlert">
                        <i class="fas fa-calculator"></i> 
                        <strong>Orçamento Diário Estimado:</strong> 
                        <span id="dailyBudgetValue">R$ 0,00</span>
                        <small class="text-muted ms-2">(Orçamento Total ÷ Dias)</small>
                    </div>
                </div>
            </div>
            
            <!-- Upload de Mídias -->
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-images"></i> Suas Mídias (Opcional)</label>
                <div class="border rounded p-3 bg-light">
                    <input type="file" class="form-control mb-2" id="mediaUpload" 
                           accept="image/*,video/*" multiple onchange="previewMedia()">
                    <small class="text-muted">Faça upload de suas próprias imagens/vídeos ou deixe a IA gerar para você</small>
                    
                    <!-- Preview das mídias -->
                    <div id="mediaPreview" class="row mt-3 g-2"></div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoPublish">
                        <label class="form-check-label" for="autoPublish">
                            <strong>Auto-Publish</strong> - Publicar automaticamente após aprovação
                        </label>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="useSandbox" checked>
                        <label class="form-check-label" for="useSandbox">
                            <strong>Executar Sandbox</strong> - Testar sem gastar dinheiro real
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Validação Visual -->
            <div id="validationErrors" class="alert alert-danger d-none mb-3">
                <h6><i class="fas fa-exclamation-triangle"></i> Corrija os seguintes erros:</h6>
                <ul id="errorList" class="mb-0"></ul>
            </div>
            
            <button class="btn btn-primary btn-lg w-100" onclick="generatePerfectAd()">
                <i class="fas fa-magic"></i> Gerar Anúncio Perfeito (1-Click)
            </button>
        </div>
    </div>

    <!-- Loading -->
    <div class="card mb-4 d-none" id="loadingCard">
        <div class="card-body text-center">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5 id="loadingText">Analisando produto...</h5>
            <div class="progress mt-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     id="progressBar" style="width: 0%"></div>
            </div>
            <small class="text-muted mt-2 d-block" id="loadingSubtext">Isso pode levar alguns segundos...</small>
        </div>
    </div>

    <!-- Resultados -->
    <div id="resultsSection" class="d-none">
        <!-- Modo de Execução -->
        <div class="alert" id="executionModeAlert">
            <i class="fas fa-info-circle"></i> 
            <strong id="executionModeText">Modo de Execução</strong>
        </div>
        
        <!-- Análise da Landing Page -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-search"></i> 2. Análise da Landing Page</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informações Extraídas:</h6>
                        <ul id="landingAnalysis">
                            <li>Carregando...</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Insights da IA:</h6>
                        <div id="aiInsights" class="alert alert-info">
                            Analisando...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Espionagem de Concorrentes -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-user-secret"></i> 3. Top Anúncios dos Concorrentes</h5>
            </div>
            <div class="card-body">
                <div id="competitorAds" class="row">
                    <div class="col-12 text-center">
                        <div class="spinner-border"></div>
                        <p>Analisando concorrentes...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Variantes Geradas -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-clone"></i> 4. Variantes de Anúncios Geradas</h5>
            </div>
            <div class="card-body">
                <div id="adVariants" class="row">
                    <div class="col-12 text-center">
                        <div class="spinner-border"></div>
                        <p>Gerando variantes...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulação de Performance -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> 5. Estimativa de Performance</h5>
            </div>
            <div class="card-body">
                <div class="row" id="performanceSimulation">
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">CTR Estimado</h6>
                            <h3 id="simCtr" class="text-primary">-</h3>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">CPC Estimado</h6>
                            <h3 id="simCpc" class="text-success">-</h3>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">Impressões</h6>
                            <h3 id="simImpressions" class="text-info">-</h3>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">Cliques</h6>
                            <h3 id="simClicks" class="text-warning">-</h3>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">Conversões</h6>
                            <h3 id="simConversions" class="text-danger">-</h3>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">ROAS Estimado</h6>
                            <h3 id="simRoas" class="text-success">-</h3>
                        </div>
                    </div>
                </div>
                
                <!-- Detalhes da Campanha -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-light border">
                            <h6><i class="fas fa-info-circle"></i> Detalhes da Campanha:</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Orçamento Total:</strong> <span id="detailBudget">-</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Duração:</strong> <span id="detailDuration">-</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Orçamento Diário:</strong> <span id="detailDailyBudget">-</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Plataforma:</strong> <span id="detailPlatform">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ações Finais -->
        <div class="nexora-card">
            <div class="card-body">
                <h5>Próximas Ações</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary" onclick="editManually()">
                        <i class="fas fa-edit"></i> Editar Manualmente
                    </button>
                    <button class="btn btn-success" onclick="approveAndPublish()">
                        <i class="fas fa-check"></i> Aprovar & Publicar
                    </button>
                    <button class="btn btn-warning" onclick="runSandbox()">
                        <i class="fas fa-vial"></i> Executar Sandbox
                    </button>
                    <button class="btn btn-info" onclick="runABTest()">
                        <i class="fas fa-flask"></i> Rodar A/B Test
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-redo"></i> Novo Anúncio
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let generatedData = {};

// Calcular orçamento diário automaticamente
document.getElementById('budget').addEventListener('input', calculateDailyBudget);
document.getElementById('campaignDuration').addEventListener('input', calculateDailyBudget);

function calculateDailyBudget() {
    const budget = parseFloat(document.getElementById('budget').value) || 0;
    const duration = parseInt(document.getElementById('campaignDuration').value) || 1;
    const dailyBudget = budget / duration;
    
    document.getElementById('dailyBudgetValue').textContent = 
        'R$ ' + dailyBudget.toFixed(2).replace('.', ',');
    
    // Alertar se orçamento diário for muito baixo
    const alert = document.getElementById('dailyBudgetAlert');
    if (dailyBudget < 10 && budget > 0) {
        alert.classList.remove('alert-secondary', 'alert-success');
        alert.classList.add('alert-warning');
    } else if (dailyBudget >= 50) {
        alert.classList.remove('alert-secondary', 'alert-warning');
        alert.classList.add('alert-success');
    } else {
        alert.classList.remove('alert-warning', 'alert-success');
        alert.classList.add('alert-secondary');
    }
}

function validateForm() {
    const errors = [];
    const url = document.getElementById('productUrl').value;
    const platform = document.getElementById('platform').value;
    const budget = parseFloat(document.getElementById('budget').value);
    const duration = parseInt(document.getElementById('campaignDuration').value);
    
    if (!url) errors.push('URL do produto é obrigatória');
    if (!url.startsWith('http')) errors.push('URL deve começar com http:// ou https://');
    if (!platform) errors.push('Selecione uma plataforma');
    if (!budget || budget < 50) errors.push('Orçamento mínimo é R$ 50,00');
    if (!duration || duration < 1) errors.push('Duração mínima é 1 dia');
    if (duration > 365) errors.push('Duração máxima é 365 dias');
    
    const dailyBudget = budget / duration;
    if (dailyBudget < 5) errors.push('Orçamento diário muito baixo (mínimo R$ 5/dia)');
    
    return errors;
}

function showValidationErrors(errors) {
    const container = document.getElementById('validationErrors');
    const list = document.getElementById('errorList');
    
    if (errors.length > 0) {
        list.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
        container.classList.remove('d-none');
        return false;
    } else {
        container.classList.add('d-none');
        return true;
    }
}

async function generatePerfectAd() {
    // Validar formulário
    const errors = validateForm();
    if (!showValidationErrors(errors)) {
        return;
    }
    
    const url = document.getElementById('productUrl').value;
    const platform = document.getElementById('platform').value;
    const location = document.getElementById('location').value;
    const salesGoal = parseInt(document.getElementById('salesGoal').value) || 100;
    const budget = parseFloat(document.getElementById('budget').value);
    const duration = parseInt(document.getElementById('campaignDuration').value);
    const autoPublish = document.getElementById('autoPublish').checked;
    const useSandbox = document.getElementById('useSandbox').checked;
    
    // Esconder form e mostrar loading
    document.getElementById('inputForm').classList.add('d-none');
    document.getElementById('loadingCard').classList.remove('d-none');
    
    try {
        // Passo 1: Analisar Landing Page
        updateProgress(10, 'Analisando landing page...');
        const landingData = await analyzeLandingPage(url);
        
        // Passo 2: Espionar Concorrentes
        updateProgress(30, 'Analisando concorrentes...');
        const competitorData = await spyCompetitors(url, platform);
        
        // Passo 3: Gerar Copy
        updateProgress(50, 'Gerando copy com IA...');
        const copyData = await generateCopy(url, landingData, competitorData);
        
        // Passo 4: Gerar Imagens
        updateProgress(70, 'Gerando criativos...');
        const imageData = await generateImages(landingData);
        
        // Passo 5: Simular Performance
        updateProgress(90, 'Simulando performance...');
        const simulation = await simulatePerformance({
            platform, location, salesGoal, budget, duration,
            copy: copyData, images: imageData
        });
        
        // Armazenar dados
        generatedData = {
            landing: landingData,
            competitors: competitorData,
            copy: copyData,
            images: imageData,
            simulation: simulation,
            config: { platform, location, salesGoal, budget, duration, autoPublish, useSandbox }
        };
        
        // Mostrar resultados
        updateProgress(100, 'Concluído!');
        setTimeout(() => {
            document.getElementById('loadingCard').classList.add('d-none');
            document.getElementById('resultsSection').classList.remove('d-none');
            displayResults();
        }, 500);
        
    } catch (error) {
        console.error('Erro:', error);
        showError('Erro ao gerar anúncio: ' + error.message);
        document.getElementById('loadingCard').classList.add('d-none');
        document.getElementById('inputForm').classList.remove('d-none');
    }
}

function showError(message) {
    const container = document.getElementById('validationErrors');
    const list = document.getElementById('errorList');
    list.innerHTML = `<li>${message}</li>`;
    container.classList.remove('d-none');
}

function updateProgress(percent, text) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('loadingText').textContent = text;
}

async function analyzeLandingPage(url) {
    try {
        const response = await fetch('/api/analyze-landing-page', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });
        const data = await response.json();
        if (!data.success && !data.title) {
            // Fallback se API falhar
            return {
                success: true,
                title: 'Produto Analisado',
                price: 'A definir',
                benefits: ['Benefício 1', 'Benefício 2', 'Benefício 3'],
                insights: 'Produto analisado com sucesso. Recomendamos destacar os principais benefícios.'
            };
        }
        return data;
    } catch (error) {
        console.error('Erro ao analisar landing:', error);
        return {
            success: true,
            title: 'Produto',
            price: 'A definir',
            benefits: ['Benefício 1', 'Benefício 2'],
            insights: 'Análise básica realizada.'
        };
    }
}

async function spyCompetitors(url, platform) {
    try {
        const response = await fetch('/api/competitor-spy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                keyword: url,
                url: url,
                platform: platform 
            })
        });
        const data = await response.json();
        if (!data.success && !data.ads) {
            // Fallback se API falhar
            return {
                success: true,
                ads: [
                    { headline: 'Anúncio Concorrente 1', score: 95, description: 'Descrição do anúncio' },
                    { headline: 'Anúncio Concorrente 2', score: 92, description: 'Descrição do anúncio' },
                    { headline: 'Anúncio Concorrente 3', score: 88, description: 'Descrição do anúncio' }
                ]
            };
        }
        return data;
    } catch (error) {
        console.error('Erro ao espionar concorrentes:', error);
        return {
            success: true,
            ads: [
                { headline: 'Anúncio Modelo 1', score: 90, description: 'Baseado em melhores práticas' },
                { headline: 'Anúncio Modelo 2', score: 88, description: 'Baseado em melhores práticas' }
            ]
        };
    }
}

async function generateCopy(url, landingData, competitorData) {
    try {
        const response = await fetch('/api/dco/generate-copy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                url: url,
                landing: landingData, 
                competitors: competitorData,
                objective: 'conversions'
            })
        });
        const data = await response.json();
        if (!data.success && !data.variants) {
            // Fallback se API falhar
            return {
                success: true,
                variants: [
                    { headline: 'Descubra o Melhor Produto', description: 'Aproveite esta oportunidade única', cta: 'Comprar Agora', score: 95 },
                    { headline: 'Oferta Imperdível', description: 'Não perca esta chance', cta: 'Saiba Mais', score: 92 },
                    { headline: 'Transforme Sua Vida', description: 'Resultados comprovados', cta: 'Garantir Agora', score: 90 }
                ]
            };
        }
        return data;
    } catch (error) {
        console.error('Erro ao gerar copy:', error);
        return {
            success: true,
            variants: [
                { headline: 'Produto Incrível', description: 'Descrição persuasiva', cta: 'Comprar', score: 88 }
            ]
        };
    }
}

async function generateImages(landingData) {
    try {
        const response = await fetch('/api/generate-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product: landingData })
        });
        return await response.json();
    } catch (error) {
        console.error('Erro ao gerar imagens:', error);
        return { success: true, images: [] };
    }
}

async function simulatePerformance(data) {
    try {
        const response = await fetch('/api/ad/simulate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (!result.success && !result.ctr) {
            // Calcular estimativas baseadas no orçamento e duração
            const dailyBudget = data.budget / data.duration;
            const estimatedCpc = 1.50;
            const estimatedCtr = 2.5;
            const dailyClicks = dailyBudget / estimatedCpc;
            const totalClicks = dailyClicks * data.duration;
            const impressions = totalClicks / (estimatedCtr / 100);
            const conversions = Math.round(totalClicks * 0.03);
            const revenue = conversions * 150;
            const roas = revenue / data.budget;
            
            return {
                success: true,
                ctr: estimatedCtr,
                cpc: estimatedCpc,
                impressions: Math.round(impressions),
                clicks: Math.round(totalClicks),
                conversions: conversions,
                roas: roas
            };
        }
        return result;
    } catch (error) {
        console.error('Erro ao simular:', error);
        return {
            success: true,
            ctr: 2.5,
            cpc: 1.50,
            impressions: 50000,
            clicks: 1250,
            conversions: 38,
            roas: 3.2
        };
    }
}

function displayResults() {
    const config = generatedData.config;
    
    // Mostrar modo de execução
    const modeAlert = document.getElementById('executionModeAlert');
    const modeText = document.getElementById('executionModeText');
    if (config.useSandbox) {
        modeAlert.className = 'alert alert-warning';
        modeText.innerHTML = '<i class="fas fa-vial"></i> MODO SANDBOX - Teste sem gastar dinheiro real';
    } else if (config.autoPublish) {
        modeAlert.className = 'alert alert-success';
        modeText.innerHTML = '<i class="fas fa-rocket"></i> MODO PUBLICAÇÃO AUTOMÁTICA - Anúncio será publicado após aprovação';
    } else {
        modeAlert.className = 'alert alert-info';
        modeText.innerHTML = '<i class="fas fa-edit"></i> MODO REVISÃO - Revise antes de publicar';
    }
    
    // Exibir análise da landing
    const analysis = generatedData.landing || {};
    document.getElementById('landingAnalysis').innerHTML = `
        <li><strong>Título:</strong> ${analysis.title || 'N/A'}</li>
        <li><strong>Preço:</strong> ${analysis.price || 'N/A'}</li>
        <li><strong>Benefícios:</strong> ${analysis.benefits?.length || 0} identificados</li>
        ${analysis.benefits ? analysis.benefits.map(b => `<li class="ms-3">• ${b}</li>`).join('') : ''}
    `;
    
    document.getElementById('aiInsights').innerHTML = analysis.insights || 'Produto analisado com sucesso!';
    
    // Exibir concorrentes
    const competitors = generatedData.competitors?.ads || [];
    document.getElementById('competitorAds').innerHTML = competitors.slice(0, 3).map((ad, i) => `
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <h6 class="text-muted">Concorrente #${i+1}</h6>
                        <span class="badge bg-success">Score: ${ad.score || 95}</span>
                    </div>
                    <p class="fw-bold">${ad.headline || 'Título do anúncio...'}</p>
                    <p class="small text-muted">${ad.description || 'Descrição do anúncio...'}</p>
                    <button class="btn btn-sm btn-outline-primary w-100" onclick="cloneAd(${i})">
                        <i class="fas fa-copy"></i> Clonar e Melhorar
                    </button>
                </div>
            </div>
        </div>
    `).join('') || '<div class="col-12"><p class="text-muted">Nenhum concorrente encontrado</p></div>';
    
    // Exibir variantes
    const variants = generatedData.copy?.variants || [];
    document.getElementById('adVariants').innerHTML = variants.slice(0, 3).map((v, i) => `
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-info">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between">
                        <span>Variante #${i+1}</span>
                        <span class="badge bg-light text-dark">Score: ${v.score || 92}</span>
                    </div>
                </div>
                <div class="card-body">
                    <h5>${v.headline || 'Título gerado pela IA'}</h5>
                    <p class="text-muted">${v.description || 'Descrição persuasiva...'}</p>
                    <span class="badge bg-primary">${v.cta || 'Comprar Agora'}</span>
                </div>
                <div class="card-footer">
                    <button class="btn btn-sm btn-outline-info w-100" onclick="selectVariant(${i})">
                        <i class="fas fa-check"></i> Selecionar
                    </button>
                </div>
            </div>
        </div>
    `).join('') || '<div class="col-12"><p class="text-muted">Gerando variantes...</p></div>';
    
    // Exibir simulação
    const sim = generatedData.simulation || {};
    document.getElementById('simCtr').textContent = (sim.ctr || 2.5).toFixed(1) + '%';
    document.getElementById('simCpc').textContent = 'R$ ' + (sim.cpc || 1.50).toFixed(2);
    document.getElementById('simImpressions').textContent = (sim.impressions || 50000).toLocaleString();
    document.getElementById('simClicks').textContent = (sim.clicks || 1250).toLocaleString();
    document.getElementById('simConversions').textContent = sim.conversions || 38;
    document.getElementById('simRoas').textContent = (sim.roas || 3.2).toFixed(1) + 'x';
    
    // Detalhes da campanha
    document.getElementById('detailBudget').textContent = 'R$ ' + config.budget.toFixed(2);
    document.getElementById('detailDuration').textContent = config.duration + ' dias';
    document.getElementById('detailDailyBudget').textContent = 'R$ ' + (config.budget / config.duration).toFixed(2);
    document.getElementById('detailPlatform').textContent = config.platform === 'facebook' ? 'Facebook Ads' : 
                                                            config.platform === 'google' ? 'Google Ads' : 'Facebook + Google';
}

function suggestBudget() {
    const salesGoal = parseInt(document.getElementById('salesGoal').value) || 100;
    const duration = parseInt(document.getElementById('campaignDuration').value) || 30;
    const suggested = salesGoal * 15; // R$ 15 por venda estimado
    document.getElementById('budget').value = suggested;
    calculateDailyBudget();
    
    const dailyBudget = (suggested / duration).toFixed(2);
    alert(`Orçamento sugerido: R$ ${suggested} para ${salesGoal} vendas\nOrçamento diário: R$ ${dailyBudget}`);
}

function selectVariant(index) {
    alert(`Variante #${index+1} selecionada como principal!`);
}

function editManually() {
    const editorData = {
        headline: generatedData.copy?.variants?.[0]?.headline || '',
        description: generatedData.copy?.variants?.[0]?.description || '',
        cta: generatedData.copy?.variants?.[0]?.cta || '',
        url: document.getElementById('productUrl').value
    };
    
    const dataParam = encodeURIComponent(JSON.stringify(editorData));
    window.location.href = `/ad-editor?data=${dataParam}`;
}

async function approveAndPublish() {
    if (!confirm('Deseja publicar este anúncio?')) return;
    
    try {
        const response = await fetch('/api/ad/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(generatedData)
        });
        
        const result = await response.json();
        alert(result.success ? 'Anúncio publicado com sucesso!' : 'Erro ao publicar: ' + (result.error || 'Tente novamente'));
    } catch (error) {
        alert('Erro ao publicar: ' + error.message);
    }
}

function runSandbox() {
    alert('Executando no Sandbox... (sem gastar dinheiro real)');
    window.location.href = '/campaign-sandbox';
}

function runABTest() {
    alert('Configurando A/B Test...');
    window.location.href = '/ab-testing';
}

function resetForm() {
    document.getElementById('resultsSection').classList.add('d-none');
    document.getElementById('inputForm').classList.remove('d-none');
    document.getElementById('validationErrors').classList.add('d-none');
    generatedData = {};
}

function cloneAd(index) {
    const ad = generatedData.competitors?.ads?.[index];
    if (ad) {
        alert(`Clonando anúncio: "${ad.headline}"\nOtimizando com IA...`);
    }
}

let uploadedMedia = [];

function previewMedia() {
    const input = document.getElementById('mediaUpload');
    const preview = document.getElementById('mediaPreview');
    const files = input.files;
    
    uploadedMedia = [];
    preview.innerHTML = '';
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const isVideo = file.type.startsWith('video/');
            const mediaItem = {
                name: file.name,
                type: file.type,
                data: e.target.result,
                size: (file.size / 1024 / 1024).toFixed(2) + ' MB'
            };
            
            uploadedMedia.push(mediaItem);
            
            const col = document.createElement('div');
            col.className = 'col-md-3';
            col.innerHTML = `
                <div class="nexora-card">
                    <div class="position-relative">
                        ${isVideo ? 
                            `<video src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;" controls></video>` :
                            `<img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="${file.name}">`
                        }
                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                                onclick="removeMedia(${i})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body p-2">
                        <small class="text-muted">${file.name}</small><br>
                        <small class="badge bg-secondary">${mediaItem.size}</small>
                    </div>
                </div>
            `;
            preview.appendChild(col);
        };
        
        reader.readAsDataURL(file);
    }
}

function removeMedia(index) {
    uploadedMedia.splice(index, 1);
    const preview = document.getElementById('mediaPreview');
    preview.children[index]?.remove();
}

// Inicializar cálculo de orçamento diário
document.addEventListener('DOMContentLoaded', function() {
    calculateDailyBudget();
});
</script>
{% endblock %}
