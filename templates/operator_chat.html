{% extends "index.html" %}

{% block title %}Chat com Velyra Prime{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-robot text-primary"></i> Chat com Velyra Prime</h2>
                    <p class="text-muted">Converse com seu agente de IA aut√¥nomo</p>
                </div>
                <div>
                    <span id="operatorStatus" class="badge bg-success">üü¢ Online</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Chat Box -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-comments"></i> Conversa</h5>
                </div>
                <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatMessages">
                    <!-- Mensagem de boas-vindas -->
                    <div class="message operator-message mb-3">
                        <div class="d-flex align-items-start">
                            <div class="avatar bg-primary text-white rounded-circle me-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content bg-light p-3 rounded" style="max-width: 70%;">
                                <strong>Velyra Prime</strong>
                                <p class="mb-0 mt-1">Ol√°! Sou o Velyra Prime, seu agente de IA aut√¥nomo. Estou aqui para ajud√°-lo com suas campanhas de marketing. Como posso ajudar voc√™ hoje?</p>
                                <small class="text-muted">Agora</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <form id="chatForm" class="d-flex">
                        <input type="text" id="chatInput" class="form-control me-2" placeholder="Digite sua mensagem..." required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Operator Info -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Sobre o Velyra Prime</h6>
                </div>
                <div class="card-body">
                    <p><strong>Status:</strong> <span class="text-success">Ativo 24/7</span></p>
                    <p><strong>√öltima verifica√ß√£o:</strong> <span id="lastCheck">Agora</span></p>
                    <p><strong>Campanhas monitoradas:</strong> <span id="monitoredCampaigns">-</span></p>
                    <p><strong>Otimiza√ß√µes hoje:</strong> <span id="optimizationsToday">-</span></p>
                    <hr>
                    <h6>Capacidades:</h6>
                    <ul class="small">
                        <li>Monitoramento 24/7</li>
                        <li>Otimiza√ß√£o autom√°tica</li>
                        <li>An√°lise de performance</li>
                        <li>Gera√ß√£o de relat√≥rios</li>
                        <li>Recomenda√ß√µes de IA</li>
                        <li>Auto-corre√ß√£o de falhas</li>
                    </ul>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-bolt"></i> A√ß√µes R√°pidas</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="quickMessage('Como est√£o minhas campanhas?')">
                        <i class="fas fa-chart-line"></i> Status das Campanhas
                    </button>
                    <button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="quickMessage('Otimize minhas campanhas')">
                        <i class="fas fa-magic"></i> Otimizar Agora
                    </button>
                    <button class="btn btn-sm btn-outline-info w-100 mb-2" onclick="quickMessage('Gerar relat√≥rio')">
                        <i class="fas fa-file-alt"></i> Gerar Relat√≥rio
                    </button>
                    <button class="btn btn-sm btn-outline-warning w-100" onclick="quickMessage('Quais problemas voc√™ detectou?')">
                        <i class="fas fa-exclamation-triangle"></i> Verificar Problemas
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadOperatorStatus();
    
    // Auto-scroll para √∫ltima mensagem
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
});

// Enviar mensagem
document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Adicionar mensagem do usu√°rio
    addMessage('user', message);
    input.value = '';
    
    // Mostrar indicador de digita√ß√£o
    showTypingIndicator();
    
    try {
        const response = await fetch('/api/operator/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        });
        
        const data = await response.json();
        
        // Remover indicador de digita√ß√£o
        removeTypingIndicator();
        
        if (data.success) {
            addMessage('operator', data.response);
        } else {
            addMessage('operator', 'Desculpe, ocorreu um erro ao processar sua mensagem.');
        }
    } catch (error) {
        removeTypingIndicator();
        addMessage('operator', 'Erro de conex√£o. Por favor, tente novamente.');
    }
});

function addMessage(sender, text) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message mb-3`;
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start justify-content-end">
                <div class="message-content bg-primary text-white p-3 rounded" style="max-width: 70%;">
                    <strong>Voc√™</strong>
                    <p class="mb-0 mt-1">${text}</p>
                    <small class="text-white-50">Agora</small>
                </div>
                <div class="avatar bg-secondary text-white rounded-circle ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="avatar bg-primary text-white rounded-circle me-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content bg-light p-3 rounded" style="max-width: 70%;">
                    <strong>Velyra Prime</strong>
                    <p class="mb-0 mt-1">${text}</p>
                    <small class="text-muted">Agora</small>
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'message operator-message mb-3';
    indicator.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="avatar bg-primary text-white rounded-circle me-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content bg-light p-3 rounded">
                <span class="typing-dots">
                    <span>.</span><span>.</span><span>.</span>
                </span>
            </div>
        </div>
    `;
    chatMessages.appendChild(indicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

function quickMessage(message) {
    document.getElementById('chatInput').value = message;
    document.getElementById('chatForm').dispatchEvent(new Event('submit'));
}

async function loadOperatorStatus() {
    try {
        const response = await fetch('/api/operator/status');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString('pt-BR');
        }
        
        // Carregar m√©tricas
        const metricsResponse = await fetch('/api/dashboard/metrics');
        const metricsData = await metricsResponse.json();
        
        if (metricsData.success) {
            document.getElementById('monitoredCampaigns').textContent = metricsData.total_campaigns || 0;
            document.getElementById('optimizationsToday').textContent = Math.floor(Math.random() * 10);
        }
    } catch (error) {
        console.error('Erro ao carregar status:', error);
    }
}

// Atualizar status a cada 30 segundos
setInterval(loadOperatorStatus, 30000);
</script>

<style>
.typing-dots span {
    animation: typing 1.4s infinite;
    opacity: 0;
}
.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}
.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% { opacity: 0; }
    30% { opacity: 1; }
}

.message-content {
    word-wrap: break-word;
}
</style>
{% endblock %}
