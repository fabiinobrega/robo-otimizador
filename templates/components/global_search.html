<!-- Global Search Component - NEXORA Operator v11.7 -->

<!-- Search Button (Navbar) -->
<button class="btn btn-outline-light" onclick="openGlobalSearch()" title="Buscar (Ctrl+K)">
    <i class="fas fa-search"></i>
</button>

<!-- Search Modal -->
<div class="nexora-search-modal" id="globalSearchModal" style="display: none;">
    <div class="nexora-search-overlay" onclick="closeGlobalSearch()"></div>
    <div class="nexora-search-container">
        <div class="nexora-search-header">
            <i class="fas fa-search"></i>
            <input 
                type="text" 
                id="globalSearchInput" 
                placeholder="Buscar campanhas, anúncios, relatórios..." 
                autocomplete="off"
            >
            <button class="nexora-search-close" onclick="closeGlobalSearch()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="nexora-search-results" id="globalSearchResults">
            <div class="nexora-search-empty">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p class="text-muted">Digite para buscar...</p>
            </div>
        </div>
        <div class="nexora-search-footer">
            <span class="text-muted small">
                <kbd>↑</kbd> <kbd>↓</kbd> para navegar
                <kbd>Enter</kbd> para selecionar
                <kbd>Esc</kbd> para fechar
            </span>
        </div>
    </div>
</div>

<style>
.nexora-search-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
}

.nexora-search-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

.nexora-search-container {
    position: relative;
    width: 90%;
    max-width: 600px;
    background-color: var(--nexora-white);
    border-radius: var(--nexora-radius-2xl);
    box-shadow: var(--nexora-shadow-2xl);
    overflow: hidden;
    animation: nexora-search-slide-in 0.2s ease-out;
}

.nexora-search-header {
    display: flex;
    align-items: center;
    gap: var(--nexora-spacing-3);
    padding: var(--nexora-spacing-4);
    border-bottom: 1px solid var(--nexora-gray-200);
}

.nexora-search-header i.fa-search {
    color: var(--nexora-gray-400);
    font-size: 1.25rem;
}

.nexora-search-header input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 1.125rem;
    color: var(--nexora-gray-900);
}

.nexora-search-header input::placeholder {
    color: var(--nexora-gray-400);
}

.nexora-search-close {
    background: none;
    border: none;
    color: var(--nexora-gray-400);
    cursor: pointer;
    padding: var(--nexora-spacing-2);
    border-radius: var(--nexora-radius-md);
    transition: all var(--nexora-transition-fast);
}

.nexora-search-close:hover {
    background-color: var(--nexora-gray-100);
    color: var(--nexora-gray-600);
}

.nexora-search-results {
    max-height: 400px;
    overflow-y: auto;
}

.nexora-search-empty {
    padding: var(--nexora-spacing-12) var(--nexora-spacing-6);
    text-align: center;
}

.nexora-search-category {
    padding: var(--nexora-spacing-3) var(--nexora-spacing-4);
    font-size: var(--nexora-text-xs);
    font-weight: 600;
    color: var(--nexora-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background-color: var(--nexora-gray-50);
}

.nexora-search-item {
    display: flex;
    align-items: center;
    gap: var(--nexora-spacing-3);
    padding: var(--nexora-spacing-3) var(--nexora-spacing-4);
    cursor: pointer;
    transition: background-color var(--nexora-transition-fast);
    text-decoration: none;
    color: inherit;
}

.nexora-search-item:hover,
.nexora-search-item.active {
    background-color: var(--nexora-gray-100);
}

.nexora-search-item-icon {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--nexora-radius-lg);
    background-color: var(--nexora-gray-100);
    color: var(--nexora-primary);
}

.nexora-search-item-content {
    flex: 1;
}

.nexora-search-item-title {
    font-weight: 600;
    color: var(--nexora-gray-900);
    margin: 0;
}

.nexora-search-item-description {
    font-size: var(--nexora-text-sm);
    color: var(--nexora-gray-600);
    margin: 0;
}

.nexora-search-footer {
    padding: var(--nexora-spacing-3) var(--nexora-spacing-4);
    border-top: 1px solid var(--nexora-gray-200);
    background-color: var(--nexora-gray-50);
}

.nexora-search-footer kbd {
    padding: 0.125rem 0.375rem;
    background-color: var(--nexora-white);
    border: 1px solid var(--nexora-gray-300);
    border-radius: var(--nexora-radius-sm);
    font-size: 0.75rem;
    font-family: monospace;
}

@keyframes nexora-search-slide-in {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .nexora-search-container {
        width: 95%;
        max-width: none;
    }
    
    .nexora-search-results {
        max-height: 300px;
    }
}
</style>

<script>
let searchTimeout;
let selectedIndex = -1;

function openGlobalSearch() {
    const modal = document.getElementById('globalSearchModal');
    const input = document.getElementById('globalSearchInput');
    modal.style.display = 'flex';
    setTimeout(() => input.focus(), 100);
}

function closeGlobalSearch() {
    const modal = document.getElementById('globalSearchModal');
    const input = document.getElementById('globalSearchInput');
    modal.style.display = 'none';
    input.value = '';
    selectedIndex = -1;
    renderSearchResults([]);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+K or Cmd+K to open search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openGlobalSearch();
    }
    
    // Esc to close
    if (e.key === 'Escape') {
        closeGlobalSearch();
    }
    
    // Arrow navigation
    const modal = document.getElementById('globalSearchModal');
    if (modal.style.display === 'flex') {
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateResults(1);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateResults(-1);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            selectResult();
        }
    }
});

// Search input handler
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('globalSearchInput');
    if (!input) return;
    
    input.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (!query) {
            renderSearchResults([]);
            return;
        }
        
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
});

async function performSearch(query) {
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const results = await response.json();
        renderSearchResults(results);
    } catch (error) {
        console.error('Search error:', error);
        renderSearchResults([]);
    }
}

function renderSearchResults(results) {
    const container = document.getElementById('globalSearchResults');
    
    if (!results || results.length === 0) {
        container.innerHTML = `
            <div class="nexora-search-empty">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p class="text-muted">Nenhum resultado encontrado</p>
            </div>
        `;
        return;
    }
    
    // Group by category
    const grouped = {};
    results.forEach(item => {
        if (!grouped[item.category]) {
            grouped[item.category] = [];
        }
        grouped[item.category].push(item);
    });
    
    let html = '';
    Object.keys(grouped).forEach(category => {
        html += `<div class="nexora-search-category">${category}</div>`;
        grouped[category].forEach((item, index) => {
            html += `
                <a href="${item.url}" class="nexora-search-item" data-index="${index}">
                    <div class="nexora-search-item-icon">
                        <i class="${item.icon}"></i>
                    </div>
                    <div class="nexora-search-item-content">
                        <p class="nexora-search-item-title">${item.title}</p>
                        <p class="nexora-search-item-description">${item.description}</p>
                    </div>
                </a>
            `;
        });
    });
    
    container.innerHTML = html;
    selectedIndex = -1;
}

function navigateResults(direction) {
    const items = document.querySelectorAll('.nexora-search-item');
    if (items.length === 0) return;
    
    // Remove current selection
    if (selectedIndex >= 0 && selectedIndex < items.length) {
        items[selectedIndex].classList.remove('active');
    }
    
    // Update index
    selectedIndex += direction;
    if (selectedIndex < 0) selectedIndex = items.length - 1;
    if (selectedIndex >= items.length) selectedIndex = 0;
    
    // Add new selection
    items[selectedIndex].classList.add('active');
    items[selectedIndex].scrollIntoView({ block: 'nearest' });
}

function selectResult() {
    const items = document.querySelectorAll('.nexora-search-item');
    if (selectedIndex >= 0 && selectedIndex < items.length) {
        items[selectedIndex].click();
    }
}
</script>
